<%- include ('./partials/header.ejs') %>
<head>
  <link
    rel="shortcut icon"
    href="http://cdn.onlinewebfonts.com/svg/img_233159.png"
  />
  <script
    src="https://use.fontawesome.com/releases/v5.15.4/js/all.js"
    data-auto-replace-svg="nest"
  ></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
</head>

<title>Dashboard</title>

<style>
  body {
    background: linear-gradient(
      90deg,
      rgba(2, 0, 36, 1) 0%,
      rgba(2, 0, 36, 1) 0%,
      rgba(2, 0, 36, 1) 0%,
      rgba(134, 134, 243, 1) 0%,
      rgba(0, 212, 255, 1) 100%
    );
    /* color: white; */
    max-width: 100%;
    overflow-x: hidden;
  }
  #card {
    width: 12.5rem;
    height: 6.25rem;
    border-top-left-radius: 20px;
  }
  .cardstyle {
    margin-right: 1.25rem;
    margin-bottom: 3.125rem;
  }

  #graphCard {
    /* border: 0.1px solid rgb(20, 20, 20); */
    border-radius: 10%;
    /* box-shadow: 5px 5px 5px lightgrey; */
    height: 25rem;
    width: 22.875rem;
    height: 28rem;
    margin-bottom: 3rem;
  }
  .makeRow {
    display: flex;
    flex-wrap: wrap;
    flex-shrink: inherit;
    flex-basis: 2rem;
    justify-content: space-around;
    grid-template-columns: min-content;
  }
  #usersCard {
    width: 34rem;
    border-radius: 8%;
    height: 100%;
  }
</style>

<!-- <div class="makeRow">
  <%for(var i=0; i< 3; i++){%>
  <div class="cardstyle">
    <div class="card" id="card">
      <div class="card-body">
        <h6 class="card-title">Special</h6>
        <h5 class="card-text" style="color: grey">5525</h5>
        <h7
          style="
            color: lightgray;
            position: relative;
            bottom: 35;
            font-size: small;
          "
          >Last: 30.4k</h7
        >
        <span style="color: rgb(14, 222, 236)">
          <i
            class="fab fa-accusoft fa-3x"
            style="position: relative; left: 1.8rem; bottom: 3.125rem"
          ></i
        ></span>
      </div>
    </div>
  </div>
  <%}%>
</div> -->

<div class="makeRow">
  <div class="card" id="graphCard">
    <div class="card-body">
      <span style="text-align: center">Top Movies on Vidly</span>
      <canvas id="myChart1" style="width: 100%; height: 100%; margin-top: 0">
      </canvas>
    </div>
  </div>

  <div class="card" id="graphCard">
    <div class="card-body">
      <span style="text-align: center">Top Genres on Vidly</span>
      <canvas id="myChart2" style="width: 100%; height: 100%"></canvas>
    </div>
  </div>

  <div class="card" id="graphCard">
    <div class="card-body">
      <canvas id="myChart3" style="width: 100%; height: 100%"></canvas>
    </div>
  </div>
</div>
<div class="makeRow">
  <div class="card" id="usersCard">
    <div class="card-body">
      <h5 class="text-center">Top Movies</h5>
      <table class="table">
        <thead class="thead-dark">
          <tr>
            <th scope="col">#</th>
            <th scope="col">Title</th>
            <th scope="col">Count</th>
          </tr>
        </thead>
        <tbody>
          <%for(var i=0; i< 8; i++){%>
          <tr>
            <td><%=i+1%></td>
            <td><%=moviesList[i].title%></td>
            <td><%=moviesList[i].rentedCustomers.length%></td>
          </tr>
          <%}%>
        </tbody>
      </table>
    </div>
  </div>
  <div class="card" id="usersCard">
    <div class="card-body">
      <h5 class="text-center">Top Customers</h5>
      <table class="table">
        <thead class="thead-dark">
          <tr>
            <th scope="col">#</th>
            <th scope="col">Name</th>
            <th scope="col">Movie Count</th>
            <!-- <th scope="col">Mandle</th> -->
          </tr>
        </thead>
        <tbody>
          <%var j=1;%> <%rented.forEach(list=>{%>
          <tr>
            <td><%=j%><%j++%></td>
            <td><%=list.name%></td>
            <td><%=list.rentedMovies.length%></td>
          </tr>
          <%})%>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  const tableclass = document.getElementsByClassName("table");
  // console.log(tableclass);
  var xLabels = [];
  var yLabels = [];
  const xLabels2 = [];
  const yLabels2 = [];
  var data = [];
  async function getbardata() {
    const response = await fetch(
      "https://vidly-crm.herokuapp.com/crm/crm/dashboard/data"
    );
    data = await response.json();
    console.log(data, "data");
  }

  var genredata = [];
  async function getgenredata() {
    const response = await fetch(
      "https://vidly-crm.herokuapp.com/crm/crm/dashboard/genredata"
    );
    genredata = await response.json();
  }

  var clickdata = [];
  async function getclicks() {
    const response = await fetch(
      "https://vidly-crm.herokuapp.com/crm/crm/clicks"
    );
    clickdata = await response.json();
  }
  chart1Data();

  async function chart1Data() {
    await getbardata();
    data.forEach((list) => {
      var str = list.title;
      var matches = str.match(/\b(\w)/g);
      var acronym = matches.join("");
      // console.log(acronym);
      xLabels.push(acronym);
      yLabels.push(list.rentedCustomers.length);
    });
    const ctx = document.getElementById("myChart1").getContext("2d");
    const myChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels: xLabels,
        datasets: [
          {
            label: "#1 Movie",
            data: yLabels,
            backgroundColor: [
              "rgba(255, 99, 132, 0.7)",
              "rgba(54, 162, 235, 0.7)",
              "rgba(255, 206, 86, 0.7)",
              "rgba(75, 192, 192, 0.7)",
              "rgba(153, 102, 255, 0.7)",
              "rgba(255, 159, 64, 0.7)",
            ],
            borderColor: [
              "rgba(255, 99, 132, 1)",
              "rgba(54, 162, 235, 1)",
              "rgba(255, 206, 86, 1)",
              "rgba(75, 192, 192, 1)",
              "rgba(153, 102, 255, 1)",
              "rgba(255, 159, 64, 1)",
            ],
            borderWidth: 1,
          },
        ],
      },
      options: {
        scales: {
          y: {
            beginAtZero: true,
          },
        },
      },
    });
  }

  chart2Data();

  async function chart2Data() {
    await getgenredata();
    console.log(genredata, "genredata");

    xLabels = Object.keys(genredata);
    yLabels = Object.values(genredata);
    const ctx = document.getElementById("myChart2").getContext("2d");
    const myChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels: xLabels,
        datasets: [
          {
            label: "#1 Movie",
            data: yLabels,
            backgroundColor: [
              "rgba(255, 99, 132, 0.7)",
              "rgba(54, 162, 235, 0.7)",
              "rgba(255, 206, 86, 0.7)",
              "rgba(75, 192, 192, 0.7)",
              "rgba(153, 102, 255, 0.7)",
              "rgba(255, 159, 64, 0.7)",
            ],
            borderColor: [
              "rgba(255, 99, 132, 1)",
              "rgba(54, 162, 235, 1)",
              "rgba(255, 206, 86, 1)",
              "rgba(75, 192, 192, 1)",
              "rgba(153, 102, 255, 1)",
              "rgba(255, 159, 64, 1)",
            ],
            borderWidth: 1,
          },
        ],
      },
      options: {
        scales: {
          y: {
            beginAtZero: false,
          },
        },
      },
    });
  }

  chart3Data();

  async function chart3Data() {
    await getclicks();
    console.log(clickdata, "clicks");
    xLabels = Object.keys(clickdata);
    yLabels = Object.values(genredata);

    const ctx1 = document.getElementById("myChart3").getContext("2d");

    const mychart = new Chart(ctx1, {
      type: "bar",
      data: {
        labels: xLabels,
        datasets: [
          {
            label: "#1 Movie",
            data: yLabels,
            backgroundColor: [
              "rgba(255, 99, 132, 0.7)",
              "rgba(54, 162, 235, 0.7)",
              "rgba(255, 206, 86, 0.7)",
              "rgba(75, 192, 192, 0.7)",
              "rgba(153, 102, 255, 0.7)",
            ],
            borderColor: [
              "rgba(255, 99, 132, 1)",
              "rgba(54, 162, 235, 1)",
              "rgba(255, 206, 86, 1)",
              "rgba(75, 192, 192, 1)",
              "rgba(153, 102, 255, 1)",
            ],
            borderWidth: 1,
          },
        ],
      },
      options: {
        scales: {
          y: {
            beginAtZero: false,
          },
        },
      },
    });
  }
</script>
<%- include ('./partials/footer.ejs') %>
